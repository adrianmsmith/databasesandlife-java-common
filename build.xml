<project name="adrian-common" basedir="." default="all">

  <property name="compile-into" location="build-tmp/java-classes"/>
  <property name="distributable-zip-into" location="build-tmp/distributable-zip-expanded"/>

  <target name="find_revision" description="Sets property 'revision.number' to the head svn revision">
    <echo>Finding Subversion revision number...</echo>
    <exec executable="svn" outputproperty="svn.info.output">
      <arg line="info"/>
    </exec>
    <exec executable="perl" inputstring="${svn.info.output}" outputproperty="svn.url">
      <arg value="-e"/>
      <arg value="while (&lt;>) { if (/URL: (.+)/) { print $1; exit; } }"/>
    </exec>
    <echo>Using SVN URL: ${svn.url}</echo>

    <exec executable="svn" outputproperty="svn.log.output">
      <arg line="log -q ${svn.url}"/>
    </exec>
    <exec executable="perl" inputstring="${svn.log.output}" outputproperty="revision.number">
      <arg value="-e"/>
      <arg value="while (&lt;>) { if (/^r(\d+)/) { print $1; exit; } }"/>
    </exec>
    <echo>Will use Subversion revision r${revision.number}</echo>
  </target>

  <target name="create-databasesandlife-common-jar" depends="find_revision">
    <delete dir="${compile-into}"/> <!-- force a clean compile -->
    <mkdir dir="${compile-into}"/>
    <javac srcdir="src" destdir="${compile-into}" debug="on">
 <!-- <classpath>
        <fileset dir=".">
          <include name="java-lib/*.jar"/>
          <include name="java-lib-compile/*.jar"/>
        </fileset>
      </classpath>  -->
    </javac>
    <copy todir="${compile-into}">
      <fileset dir="src">
        <include name="**/*.properties"/>
        <include name="**/*.java"/>
      </fileset>
    </copy>
    <delete> <fileset dir="." includes="adrian-common-incl-src-r*.jar"/> </delete> 
    <jar jarfile="adrian-common-incl-src-r${revision.number}.jar" basedir="${compile-into}"/>
  </target>
  
<!--  <target name="mailtemplate-zip" depends="find_revision">
    <delete dir="${distributable-zip-into}"/>
    <mkdir dir="${distributable-zip-into}"/>
    <delete dir="${compile-into}"/>
    <mkdir dir="${compile-into}"/>
    <copy todir="${distributable-zip-into}/java-src">
      <fileset dir="src">
        <include name="com/databasesandlife/mailtemplate/**/*.java"/>
      </fileset>
    </copy>
    <javac srcdir="${distributable-zip-into}/java-src" destdir="${compile-into}" debug="on">
     <classpath>
        <fileset dir=".">
          <include name="java-lib/*.jar"/>
          <include name="java-lib-compile/*.jar"/>
        </fileset>
      </classpath>
    </javac>
    <copy todir="${compile-into}">
      <fileset dir="${distributable-zip-into}/java-src"/>
    </copy>
    <jar jarfile="${distributable-zip-into}/databasesandlife-mailtemplate-incl-src-r${revision.number}.jar" basedir="${compile-into}"/>
    <copy todir="${distributable-zip-into}" file="distributable-zip-files/LICENSE-lgpl-3.0.txt"/>
    <copy todir="${distributable-zip-into}">
      <fileset dir="distributable-zip-files/mailtemplate"/>
    </copy>
    <zip destfile="databasesandlife-mailtemplate-src.zip" basedir="${distributable-zip-into}"/>
  </target>  -->
  
  <target name="all" depends="create-databasesandlife-common-jar"/>
  
</project>
